@page "/tasks/create"
@using TaskManagementWeb.Models.DTOs
@using TaskManagementWeb.Services
@inject TaskApiService TaskService
@inject AuthService AuthService
@inject ProjectApiService ProjectService
@inject NavigationManager Nav

<h3 class="page-title text-center mb-4">Add Task</h3>

@if (!initialized)
{
    <div class="text-center text-muted py-5">
        <div class="spinner-border mb-2"></div>
        <p>Loading...</p>
    </div>
}
else
{
    <div class="d-flex justify-content-center">
        <div class="card shadow-sm p-4 w-100" style="max-width: 800px;">

            <EditForm Model="editModel" OnValidSubmit="HandleValidSubmit">
                <DataAnnotationsValidator />
                <ValidationSummary class="text-danger mb-3" />

                <!-- Title -->
                <div class="mb-4">
                    <label class="form-label fw-semibold">
                        Task Title
                    </label>
                    <InputText class="form-control rounded-3" @bind-Value="editModel.Title" placeholder="Enter task title..." />
                </div>

                <!-- Description -->
                <div class="mb-4">
                    <label class="form-label fw-semibold">Description</label>
                    <InputTextArea class="form-control rounded-3"
                                   rows="4"
                                   @bind-Value="editModel.Description"
                                   placeholder="Describe the task...">
                    </InputTextArea>
                </div>

                <div class="row">
                    <!-- Assign User -->
                    <div class="col-md-6 mb-4">
                        <label class="form-label fw-semibold">Assigned user</label>
                        <InputSelect class="form-select rounded-3" @bind-Value="editModel.AssignedUserId">
                            <option disabled value="">Select a user</option>
                            @foreach (var user in users)
                            {
                                <option value="@user.Id">@user.Username</option>
                            }
                        </InputSelect>
                    </div>

                    <!-- Project -->
                    <div class="col-md-6 mb-4">
                        <label class="form-label fw-semibold">Assigned Project</label>
                        <InputSelect class="form-select rounded-3" @bind-Value="editModel.ProjectId">
                            <option disabled value="">Select a project</option>
                            @foreach (var project in projects)
                            {
                                <option value="@project.Id">@project.Name</option>
                            }
                        </InputSelect>
                    </div>
                </div>

                <!-- Due Date -->
                <div class="mb-4">
                    <label class="form-label fw-semibold">Due Date</label>
                    <InputDate @bind-Value="editModel.DueDate"
                               class="form-control rounded-3"
                               TValue="DateTime"
                               id="dueDate"
                               min="@DateTime.Today.ToString("yyyy-MM-dd")" />
                </div>

                <!-- Status -->
                <div class="mb-4">
                    <label class="form-label fw-semibold">Status</label>
                    <InputSelect class="form-select rounded-3" @bind-Value="editModel.Status">
                        <option value="ToDo">To Do</option>
                        <option value="InProgress">In Progress</option>
                        <option value="Done">Done</option>
                    </InputSelect>
                </div>

                <!-- Buttons -->
                <div class="d-grid gap-2">
                    <button class="btn btn-primary py-2" type="submit" disabled="@saving">
                        <i class="bi bi-plus-circle me-2"></i>
                        Save Task
                    </button>

                    <button class="btn btn-outline-secondary py-2" type="button" @onclick="Cancel" disabled="@saving">
                        Cancel
                    </button>
                </div>

                @if (!string.IsNullOrEmpty(message))
                {
                    <div class="alert @(messageClass) mt-3 rounded-3">
                        @message
                    </div>
                }
            </EditForm>

        </div>
    </div>
}

@code {
    private TaskCreateDto editModel = new();
    private bool initialized = false;
    private bool saving = false;
    private string? message;
    private string messageClass = "alert-success";

    private List<ProjectDto> projects = new();
    private List<UserDto> users = new();

    protected override async Task OnInitializedAsync()
    {
        await AuthService.InitializeAsync();

        if (!AuthService.IsAuthenticated)
        {
            Nav.NavigateTo("/login", true);
            return;
        }

        projects = await ProjectService.GetVisibleProjectsAsync();
        users = await ProjectService.GetUsersAsync();

        editModel.Status = "ToDo";
        editModel.DueDate = DateTime.Today.AddDays(7);

        initialized = true;
    }


    private async Task HandleValidSubmit()
    {
        saving = true;
        message = null;

        try
        {
            if (editModel.ProjectId == 0 || editModel.AssignedUserId == 0)
            {
                message = "Please select a project and a user.";
                messageClass = "alert-danger";
                return;
            }

            var createdTask = await TaskService.CreateTaskAsync(editModel);

            if (createdTask != null)
            {
                message = "Task created successfully!";
                messageClass = "alert-success";
                Nav.NavigateTo($"/projects", true);
            }
            else
            {
                message = "Failed to create task.";
                messageClass = "alert-danger";
            }
        }
        catch (Exception ex)
        {
            message = "Error: " + ex.Message;
            messageClass = "alert-danger";
        }
        finally
        {
            saving = false;
        }
    }

    private void Cancel() =>
        Nav.NavigateTo("/projects", true);
}