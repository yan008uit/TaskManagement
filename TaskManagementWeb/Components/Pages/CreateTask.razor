@page "/tasks/create"
@using TaskManagementWeb.Models.DTOs
@using TaskManagementWeb.Services
@inject TaskService TaskService
@inject AuthService AuthService
@inject ProjectService ProjectService
@inject NavigationManager Nav

<h3 class="page-title text-center mb-4">Add Task</h3>

@if (!initialized)
{
    <p class="text-muted text-center">Loading...</p>
}
else
{
    <div class="d-flex justify-content-center">
        <div class="card p-4 w-100" style="max-width: 800px;">

            <EditForm Model="editModel" OnValidSubmit="HandleValidSubmit">
                <DataAnnotationsValidator />
                <ValidationSummary class="text-danger" />

                <div class="mb-3">
                    <label class="form-label">Task Title</label>
                    <InputText class="form-control" @bind-Value="editModel.Title" />
                </div>

                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <InputTextArea class="form-control" @bind-Value="editModel.Description" rows="4" />
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Assign to User</label>
                        <InputSelect class="form-select" @bind-Value="editModel.AssignedUserId">
                            <option value="">Select a user</option>
                            @foreach (var user in users)
                            {
                                <option value="@user.Id">@user.Username</option>
                            }
                        </InputSelect>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label">Project</label>
                        <InputSelect class="form-select" @bind-Value="editModel.ProjectId">
                            <option value="">Select a project</option>
                            @foreach (var project in projects)
                            {
                                <option value="@project.Id">@project.Name</option>
                            }
                        </InputSelect>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Due Date</label>
                    <InputDate class="form-control" @bind-Value="editModel.DueDate" />
                </div>

                <div class="mb-3">
                    <label class="form-label">Status</label>
                    <InputSelect class="form-select" @bind-Value="editModel.Status">
                        <option value="ToDo">To Do</option>
                        <option value="InProgress">In Progress</option>
                        <option value="Done">Done</option>
                    </InputSelect>
                </div>

                <button class="btn btn-primary w-100" type="submit" disabled="@saving">Save</button>
                <button class="btn btn-secondary w-100 mt-2" type="button" @onclick="Cancel" disabled="@saving">Cancel</button>

                @if (!string.IsNullOrEmpty(message))
                {
                    <p class="text-@(messageClass == "alert-success" ? "success" : "danger") mt-2">
                        @message
                    </p>
                }
            </EditForm>

        </div>
    </div>
}

@code {
    private TaskCreateDto editModel = new();
    private bool initialized = false;
    private bool saving = false;
    private string? message;
    private string messageClass = "alert-success";

    private List<ProjectDto> projects = new();
    private List<UserDto> users = new();

    protected override async Task OnInitializedAsync()
    {
        await AuthService.InitializeAsync();

        if (!AuthService.IsAuthenticated)
        {
            Nav.NavigateTo("/login", true);
            return;
        }

        var allProjects = await ProjectService.GetVisibleProjectsAsync() ?? new List<ProjectDto>();
        projects = allProjects
            .Where(p => p.UserId == AuthService.UserId)
            .ToList();

        users = await ProjectService.GetUsersAsync();

        editModel.Status = "ToDo";
        initialized = true;

    }

    private async Task HandleValidSubmit()
    {
        saving = true;
        message = null;

        try
        {
            if (editModel.ProjectId == 0 || editModel.AssignedUserId == 0)
            {
                message = "Please select a project and a user.";
                messageClass = "alert-danger";
                return;
            }

            var createdTask = await TaskService.CreateTaskAsync(editModel);

            if (createdTask != null)
            {
                message = "Task created successfully!";
                messageClass = "alert-success";
                Nav.NavigateTo($"/projects", true);
            }
            else
            {
                message = "Failed to create task.";
                messageClass = "alert-danger";
            }
        }
        catch (Exception ex)
        {
            message = "Error: " + ex.Message;
            messageClass = "alert-danger";
        }
        finally
        {
            saving = false;
        }
    }

    private void Cancel() =>
        Nav.NavigateTo("/projects", true);
}