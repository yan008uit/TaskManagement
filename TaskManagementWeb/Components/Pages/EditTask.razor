@page "/tasks/edit/{Id:int}"
@using TaskManagementWeb.Models.DTOs
@using TaskManagementWeb.Services
@inject TaskApiService TaskService
@inject ProjectApiService ProjectService
@inject AuthService AuthService
@inject NavigationManager Nav

<h3 class="page-title text-center mb-4">Edit Task</h3>

@if (!initialized)
{
    <p class="text-muted text-center">Loading...</p>
}
else if (!found)
{
    <div class="alert alert-danger text-center">
        Task not found or you don't have permission.
    </div>
}
else
{
    <div class="d-flex justify-content-center">
        <div class="card p-4 w-100" style="max-width: 800px;">

            <EditForm Model="editModel" OnValidSubmit="HandleValidSubmit">
                <DataAnnotationsValidator />
                <ValidationSummary class="text-danger" />

                <div class="mb-3">
                    <label class="form-label">Task Title</label>
                    <InputText class="form-control" @bind-Value="editModel.Title" />
                </div>

                <div class="mb-3">
                    <label class="form-label">Project</label>
                    <input class="form-control" value="@projects.FirstOrDefault(p => p.Id == editModel.ProjectId)?.Name" readonly />
                </div>

                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <InputTextArea class="form-control" @bind-Value="editModel.Description" rows="4" />
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Assign to User</label>
                        <InputSelect class="form-select" @bind-Value="editModel.AssignedUserId">
                            <option value="">Select a user</option>
                            @foreach (var user in users)
                            {
                                <option value="@user.Id">@user.Username</option>
                            }
                        </InputSelect>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Due Date</label>
                    <InputDate class="form-control" @bind-Value="editModel.DueDate" />
                </div>

                <div class="mb-3">
                    <label class="form-label">Status</label>
                    <InputSelect class="form-select" @bind-Value="editModel.Status">
                        <option value="ToDo">To Do</option>
                        <option value="InProgress">In Progress</option>
                        <option value="Done">Done</option>
                    </InputSelect>
                </div>

                <button class="btn btn-primary w-100" type="submit" disabled="@saving">Save</button>
                <button class="btn btn-secondary w-100 mt-2" type="button" @onclick="Cancel" disabled="@saving">Cancel</button>

                @if (!string.IsNullOrEmpty(message))
                {
                    <p class="text-@(messageClass == "alert-success" ? "success" : "danger") mt-2">
                        @message
                    </p>
                }
            </EditForm>

        </div>
    </div>
}

@code {
    [Parameter] public int Id { get; set; }

    private TaskUpdateDto editModel = new();
    private bool initialized = false;
    private bool found = true;
    private bool saving = false;
    private string? message;
    private string messageClass = "alert-success";

    private List<ProjectDto> projects = new();
    private List<UserDto> users = new();

    protected override async Task OnInitializedAsync()
    {
        await AuthService.InitializeAsync();

        if (!AuthService.IsAuthenticated)
        {
            Nav.NavigateTo("/login", true);
            return;
        }

        // Load projects and users
        projects = await ProjectService.GetVisibleProjectsAsync() ?? new();
        users = await ProjectService.GetUsersAsync();

        var task = await TaskService.GetTaskAsync(Id);

        if (task == null ||
            (task.CreatedByUserId != AuthService.UserId && task.AssignedUserId != AuthService.UserId))
        {
            found = false;
            initialized = true;
            return;
        }

        editModel.Title = task.Title;
        editModel.Description = task.Description;
        editModel.Status = task.Status ?? "ToDo";
        editModel.DueDate = task.DueDate;
        editModel.AssignedUserId = task.AssignedUserId;
        editModel.ProjectId = task.ProjectId;

        initialized = true;
    }

    private async Task HandleValidSubmit()
    {
        saving = true;
        message = null;

        try
        {
            if (editModel.AssignedUserId == 0)
            {
                message = "Please select a user.";
                messageClass = "alert-danger";
                return;
            }

            var ok = await TaskService.UpdateTaskAsync(Id, editModel);

            if (ok)
            {
                message = "Task updated successfully.";
                messageClass = "alert-success";
                Nav.NavigateTo($"/tasks/{Id}", true);
            }
            else
            {
                message = "Update failed (task not found or no permission).";
                messageClass = "alert-danger";
            }
        }
        catch (Exception ex)
        {
            message = "Error updating task: " + ex.Message;
            messageClass = "alert-danger";
        }
        finally
        {
            saving = false;
        }
    }

    private void Cancel() =>
        Nav.NavigateTo($"/tasks/{Id}", true);
}