@using TaskManagementWeb.Models.DTOs
@using TaskManagementWeb.Services

<div class="card mb-3 p-3 @(GetStatusClass(Task.Status))">

    <!-- Task Title & Description -->
    <strong class="project-name">@Task.Title</strong>
    <p class="project-desc text-truncate">@Task.Description</p>
    <p class="mb-2 text-muted">
        Due: @(Task.DueDate?.ToString("yyyy-MM-dd") ?? "No due date")
    </p>

    <!-- Assigned User -->
    <p><strong>Assigned User:</strong></p>
    <div class="mb-2 d-flex align-items-center gap-2">
        @if (Task.CreatedByUserId == AuthService.UserId)
        {
            <select class="form-select form-select-sm w-auto"
                    @bind-value="AssignedUserId"
                    @bind-value:event="onchange">
                <option value="">Assign User…</option>
                @foreach (var u in Users)
                {
                    <option value="@u.Id">@u.Username</option>
                }
            </select>
        }
        else
        {
            <span class="badge @(GetAssignedUser()?.Username != null ? "bg-primary" : "bg-secondary")">
                @(GetAssignedUser()?.Username ?? "Unassigned")
            </span>
        }
    </div>

    <!-- Status & Actions -->
    <div class="d-flex gap-2 flex-wrap mt-2 align-items-center">
        @if (Task.AssignedUserId == AuthService.UserId)
        {
            <select class="form-select form-select-sm w-auto"
                    @bind-value="TaskStatus"
                    @bind-value:event="onchange">
                <option value="ToDo">To Do</option>
                <option value="InProgress">In Progress</option>
                <option value="Done">Done</option>
            </select>
        }
        else
        {
            <select class="form-select form-select-sm w-auto" disabled>
                <option>@FormatStatus(Task.Status)</option>
            </select>
        }

        @if (CanViewTask)
        {
            <button class="btn btn-sm btn-outline-primary" @onclick="() => OnViewTask.InvokeAsync(Task)">View</button>
        }

        @if (CanDeleteTask)
        {
            <button class="btn btn-sm btn-outline-danger" @onclick="() => OnDeleteTask.InvokeAsync(Task)">Delete</button>
        }
    </div>
</div>

@code {
    [Parameter] public TaskDto Task { get; set; } = default!;
    [Parameter] public List<UserDto> Users { get; set; } = new();
    [Parameter] public AuthService AuthService { get; set; } = default!;

    [Parameter] public EventCallback<(TaskDto Task, string? NewStatus)> OnStatusChanged { get; set; }
    [Parameter] public EventCallback<(TaskDto Task, int UserId)> OnUserAssigned { get; set; }
    [Parameter] public EventCallback<TaskDto> OnDeleteTask { get; set; }
    [Parameter] public EventCallback<TaskDto> OnViewTask { get; set; }

    private bool CanViewTask => Task.AssignedUserId == AuthService.UserId
                            || Task.CreatedByUserId == AuthService.UserId
                            || Task.ProjectOwnerId == AuthService.UserId;

    private bool CanDeleteTask => Task.AssignedUserId == AuthService.UserId
                               || Task.CreatedByUserId == AuthService.UserId;

    private UserDto? GetAssignedUser()
        => Task.AssignedUserId.HasValue ? Users.FirstOrDefault(u => u.Id == Task.AssignedUserId.Value) : null;

    // Two-way binding for assigned user
    private int? AssignedUserId
    {
        get => Task.AssignedUserId;
        set
        {
            if (Task.AssignedUserId != value)
            {
                Task.AssignedUserId = value;
                if (value.HasValue)
                {
                    _ = OnUserAssigned.InvokeAsync((Task, value.Value));
                }
            }
        }
    }

    // Two-way binding for task status
    private string? TaskStatus
    {
        get => Task.Status;
        set
        {
            if (Task.Status != value)
            {
                Task.Status = value;
                _ = OnStatusChanged.InvokeAsync((Task, value));
            }
        }
    }

    private string GetStatusClass(string? status) => status switch
    {
        "ToDo" => "task-todo",
        "InProgress" => "task-inprogress",
        "Done" => "task-done",
        _ => ""
    };

    private string FormatStatus(string? status) => status switch
    {
        "ToDo" => "To do",
        "InProgress" => "In progress",
        "Done" => "Done",
        _ => "Unknown"
    };
}