@page "/tasks/{ProjectId:int}"
@using TaskManagementWeb.Models
@using TaskManagementWeb.Services
@inject TaskService TaskService
@inject NavigationManager Nav

<h3>Tasks for Project @ProjectId</h3>

@if (tasks == null)
{
    <p>Loading...</p>
}
else
{
    <button class="btn btn-success mb-3" @onclick="() => showAddForm = !showAddForm">
        @(showAddForm ? "Cancel" : "Add Task")
    </button>

    @if (showAddForm)
    {
        <div class="card p-3 mb-3">
            <input class="form-control mb-2" placeholder="Title" @bind="newTask.Title" />
            <textarea class="form-control mb-2" placeholder="Description" @bind="newTask.Description"></textarea>
            <button class="btn btn-primary" @onclick="CreateTask">Create</button>
        </div>
    }

    <ul class="list-group">
        @foreach (var t in tasks)
        {
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>@t.Title (@t.Status)</span>
                <div>
                    <button class="btn btn-sm btn-primary" @onclick="@(() => Nav.NavigateTo($"/comments/{t.Id}"))">Comments</button>
                    <button class="btn btn-sm btn-danger" @onclick="@(() => DeleteTask(t.Id))">Delete</button>
                </div>
            </li>
        }
    </ul>
}

@code {
    [Parameter] public int ProjectId { get; set; }

    private List<TaskDto>? tasks;
    private TaskCreateUpdateDto newTask = new();
    private bool showAddForm = false;

    protected override async Task OnInitializedAsync()
    {
        newTask.ProjectId = ProjectId;
        tasks = await TaskService.GetTasksByProjectAsync(ProjectId);
    }

    private async Task CreateTask()
    {
        var created = await TaskService.CreateTaskAsync(newTask);
        if (created != null)
        {
            tasks!.Add(created);
            showAddForm = false;
            newTask = new() { ProjectId = ProjectId };
        }
    }

    private async Task DeleteTask(int id)
    {
        var success = await TaskService.DeleteTaskAsync(id);
        if (success)
        {
            tasks = tasks!.Where(t => t.Id != id).ToList();
        }
    }
}